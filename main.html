<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>五子棋</title>
</head>
<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="js/const.js" type="text/javascript"></script>
<script type="text/javascript">
	//棋盘
	var chessboard = cchessboard;
	//游戏模式
	var debug=cdebug;
	//游戏参数
	var boardsize=cboardsize;
	var depth=cdepth;
	var maxdepth=cmaxdepth;

	var historys = [];
	var turn=0; //轮到黑棋:0/白棋:1

	//游戏状态
	var calculating=false;
	var started=false;
	var finished=false;
</script>
<script src="js/support.js" type="text/javascript"></script>
<script src="js/draw.js" type="text/javascript"></script>
<script type="text/javascript">

	window.onload=function(){

		var background=document.getElementById("background");
		background.style.left=parseInt((document.body.clientWidth-background.width)/2).toString()+"px";
		var doback = document.getElementById("back");
		var doexport = document.getElementById("export");
		var youfirst = document.getElementById("youfirst");
		var calculater = new Worker("./js/calculate.js");
		turn = initdraw(chessboard);


		//电脑先手
		youfirst.onclick = function(e)
		{
			if(started)
				return;
			calculater.postMessage({
				"type" : "justchess",
				"point" : [7,7],
				"turn" : 0
			});
			dochess(7,7,0);
			turn=1;
		}

		//悔棋
		doback.onclick = function(e)
		{
			var ev = e || window.event;
			var cxt=document.getElementById("background").getContext("2d");
			var len = historys.length;
			if (calculating||len<2)
				return

			calculater.postMessage({
				"type" : "retract",
				"turn" : 1-turn
			});

			var point1 = historys.pop()
			chessboard[point1[0]][point1[1]]=-1;
			cxt.clearRect(point1[1]*35+10,point1[0]*35+10,25,25)

			point1 = historys.pop()
			chessboard[point1[0]][point1[1]]=-1;
			cxt.clearRect(point1[1]*35+10,point1[0]*35+10,25,25)

			finished=false;
		}

		//棋盘状态导出
		doexport.onclick = function(e)
		{
			var str="";
			for(var i=0;i<15;i++)
			{
				str+="["+chessboard[i].toString()+"],\n"
			}
			console.log(str);
		}

		//消除棋盘右击菜单
		background.oncontextmenu = function(e){
            e.preventDefault();
        };

        /*DEBUG用，按键定位*/
        background.onmouseup = function(e)
        {
        	var ev = e || window.event;
        	if(ev.button!=2)
        		return
        	var x = ev.offsetX-22
			var y = ev.offsetY-22
			var tx = parseInt(x/35+0.5)
			var ty = parseInt(y/35+0.5)
			console.log(ty,tx)
        }

        //棋盘点击操作
		background.onclick=function(e){
			//判断是否可下棋
			if(calculating||finished)
				return;
			else
				calculating=true;

			//点击定位
			var ev = e || window.event;
			var x = ev.offsetX-22
			var y = ev.offsetY-22
			var tx = parseInt(x/35+0.5)
			var ty = parseInt(y/35+0.5)
			if(chessboard[ty][tx]!=-1)
			{
				calculating=false;
				return;
			}
			console.log("clicked!");

			//下棋
			dochess(tx,ty,turn)
			turn=1-turn;
			if(finished)
			{
				calculating=false;
				return
			}
			//传递消息开始计算
			calculater.postMessage({
				"type" : "calculate",
				"point" : [ty,tx],
				"turn" : 1-turn
			});
			console.time("Runtime")
		}
		calculater.onmessage = function(e)
		{
			var data=e.data;
			if(data.type=="finish_calculate")
			{
				if(turn!=data.turn)
				{
					console.log("Turn ERROR!");
					return;
				}
				console.timeEnd("Runtime")
				dochess(data.point[1],data.point[0],data.turn);
				turn=1-turn;
				calculating=false;
			}
		};
	}

	window.onresize=function(){
		var background=document.getElementById("background")
		background.style.left=parseInt((document.body.clientWidth-background.width)/2).toString()+"px";
	}
</script>
<style type="text/css">
	#background{
		position : fixed;
		z-index : 1;
		left: 50%;
		top: 20%;
		background-image: url("img/board.jpg");
		background-repeat:no-repeat;
		background-size:100%,100%;
	}
</style>
<body>
<button id="back">悔棋</button>
<button id="export">导出</button>
<button id="youfirst">电脑先手</button>
<canvas id="background" width="535" height="535"></canvas>
</body>
</html>